<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="language" content="english">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="content-type" content="text/html">
  <meta name="author" content="Yoogottam Khandelwal">
  <meta name="designer" content="Yoogottam Khandelwal">

  
    <meta property="og:title" content="Port based routing">
    <meta property="og:image" content="http://localhost:4000/assets/images/posts/split-path.webp">
    <meta property="og:description" content="Recently, my ISP started blocking outbound ssh connections[*] and that hindered my workflow a lot. The only other internet connection I had was my mobile phone’s wireless hotspot (limited data)....">
  
  
  

  <meta property="og:url" content="http://localhost:4000/blog/port-based-routing">

  <title>Port Based Routing | yoogottamk</title>

  <!-- bootstrap css -->

<link rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
  integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
  crossorigin="anonymous" />

<link rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
  crossorigin="anonymous" />

<!-- fonts, included only where required to reduce load time -->

  
    
      <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald&display=swap" rel="stylesheet" />
    
  

  

  


<!-- fonts to be loaded on all pages are here -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato&display=swap" />


  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/copy-code.css">
  <link rel="shortcut icon" href="/assets/images/yoogottamk.webp" type="image/x-icon" />
</head>

<body>
  <div class="content">
    <!-- custom css for managing navbar -->
<link rel="stylesheet" href="/css/navbar.css" />
<script src="/js/navbar.js"></script>

<nav id="navbar" class="navbar navbar-expand-lg navbar-dark fixed-top">
  <button class="navbar-toggler" type="button" data-toggle="modal" data-target="#navbarContentSmall" aria-label="Show/hide navbar">
    <span class="navbar-toggler-icon"></span>
  </button>

  <a class="navbar-brand" href="/">
    <img src="/assets/images/yoogottamk.webp" alt="yk logo" width="30" height="30">
    yoogottamk
  </a>

  <div class="collapse navbar-collapse" id="navbarContent">
    <ul class="navbar-nav ml-auto">
      
      
        <li class="nav-item">
          <a class="nav-link active" href="/blog/">
            <i class="fa fa-pencil-square nav-icon align-middle" aria-hidden="true"></i>
            <span class="align-middle">My blog</span>
          </a>
          <div class="nav-desc">My experiences with vim, GNU plus linux and other cool stuff</div>
        </li>
      
        <li class="nav-item">
          <a class="nav-link " href="/projects/">
            <i class="fa fa-flash nav-icon align-middle" aria-hidden="true"></i>
            <span class="align-middle">My projects</span>
          </a>
          <div class="nav-desc">Some stuff that I did in the small time I managed to get</div>
        </li>
      
        <li class="nav-item">
          <a class="nav-link " href="/snippets/">
            <i class="fa fa-code nav-icon align-middle" aria-hidden="true"></i>
            <span class="align-middle">Snippets</span>
          </a>
          <div class="nav-desc">Cool random code snippets</div>
        </li>
      
        <li class="nav-item">
          <a class="nav-link " href="/about/">
            <i class="fa fa-info-circle nav-icon align-middle" aria-hidden="true"></i>
            <span class="align-middle">About me</span>
          </a>
          <div class="nav-desc">Want to know more about me?</div>
        </li>
      
    </ul>
  </div>
</nav>

<div class="modal left fade" id="navbarContentSmall" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5>yoogottamk</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <ul class="navbar-nav ml-auto">
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="fa fa-pencil-square nav-icon align-middle" aria-hidden="true"></i>
                My blog
              </a>
              <div class="nav-desc">My experiences with vim, GNU plus linux and other cool stuff</div>
            </li>
            <hr>
          
            <li class="nav-item">
              <a class="nav-link" href="/projects/">
                <i class="fa fa-flash nav-icon align-middle" aria-hidden="true"></i>
                My projects
              </a>
              <div class="nav-desc">Some stuff that I did in the small time I managed to get</div>
            </li>
            <hr>
          
            <li class="nav-item">
              <a class="nav-link" href="/snippets/">
                <i class="fa fa-code nav-icon align-middle" aria-hidden="true"></i>
                Snippets
              </a>
              <div class="nav-desc">Cool random code snippets</div>
            </li>
            <hr>
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="fa fa-info-circle nav-icon align-middle" aria-hidden="true"></i>
                About me
              </a>
              <div class="nav-desc">Want to know more about me?</div>
            </li>
            <hr>
          
        </ul>
      </div>
    </div>
  </div>
</div>


    <link rel="stylesheet" href="/css/post.css">
<link rel="stylesheet" href="/css/syntax.css">

<div class="jumbotron jumbotron-fluid"
   style="background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 1)), url(/assets/images/posts/split-path.webp);">
  <div class="container">
    <h1>Port based routing</h1>
    February 16, 2021
  </div>
</div>

<div class="container" id="post-body">
  <p>Recently, my ISP started blocking outbound ssh connections[*] and that hindered my workflow a lot. The only other internet connection I had was my mobile phone’s wireless hotspot (limited data). Somehow, I need to send ONLY the ssh packets through my wireless interface. [<a href="#script">skip to script</a>]</p>

<h2 class="section-header pt-4">(*)</h2>
<p>they blocked port 22 and a few others (no <a href="https://www.wikiwand.com/en/Deep_packet_inspection" target="_blank" rel="noopener">deep packet inspection</a>)</p>

<div class="py-4"></div>

<div class="text-center py-4">· · ·</div>

<h1 class="section-header">The solution</h1>

<p>I’m connected to the ISP through my ethernet cable, so my wireless interface was free.</p>

<h2 class="section-header pt-4">Step 1: Mark packets</h2>
<p>We can use iptables to mark the tcp packets that are going through my eth interface (<code class="highlighter-rouge">eno1</code>) that have destination port 22 (ssh runs on 22 by default)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>iptables <span class="nt">-t</span> mangle <span class="nt">-I</span> OUTPUT <span class="nt">-o</span> eno1 <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> MARK <span class="nt">--set-mark</span> 1
</code></pre></div></div>

<h2 class="section-header pt-4">Step 2: Route packets</h2>
<p>Now that we have marked the packets, we need to make sure they go through my wireless interface (<code class="highlighter-rouge">wlo1</code>). For this, we can create a new routing table such that the default gateway is the gateway for my wireless network. (Basically, it means that all packets that use this routing table will go through my wireless network).</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ip route add table 22 default via 192.168.0.1
</code></pre></div></div>

<p>Now, we just need to make sure that all marked packets use this routing table</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ip rule add fwmark 0x1 table 22
</code></pre></div></div>

<h2 class="section-header pt-4">Step 3: Fix packets</h2>
<p>Unfortunately, this setup wouldn’t work. The reason is that although those packets will now go through <code class="highlighter-rouge">wlo1</code>, the source IP is messed up (it still would be my IP on <code class="highlighter-rouge">eno1</code> network). This will cause all packets to drop. To fix this, we can do <a href="https://www.wikiwand.com/en/Network_address_translation" rel="noopener" target="_blank">Network Address Translation (NAT)</a></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-I</span> POSTROUTING <span class="nt">-o</span> wlo1 <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> SNAT <span class="nt">--to</span> 192.168.0.2
</code></pre></div></div>

<p>This basically changes the packets source to use my IP on the wireless network (here, <code class="highlighter-rouge">192.168.0.2</code>)</p>

<p><span id="script"></span></p>

<div class="text-center py-4">· · ·</div>

<h1 class="section-header">Final script</h1>

<p>This script takes care of setting up the rules and deleting them when the task is done. It also figures out the gateway and device’s IP on the wireless network.</p>

<!-- this section was taken from
  https://www.aleksandrhovhannisyan.com/blog/how-to-add-a-copy-to-clipboard-button-to-your-jekyll-blog/
-->

<!--
  BEGIN_SECTION
-->
<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<!--
  END_SECTION
-->

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">function </span><span class="nb">help</span> <span class="o">{</span>
    <span class="o">&gt;</span>&amp;2 <span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> up|down"</span>
    <span class="nb">exit </span>1
<span class="o">}</span>

<span class="o">[[</span> <span class="nv">$# </span><span class="o">==</span> 1 <span class="o">]]</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">help</span><span class="p">;</span> <span class="o">}</span>

<span class="c"># `iptables -A ...` and `ip route/rule add ...` while running "up"</span>
<span class="c"># `iptables -D ...` and `ip route/rule del ...`while running "down"</span>
<span class="k">case</span> <span class="nv">$1</span> <span class="k">in
    </span>up<span class="p">)</span>
        <span class="nv">ipt</span><span class="o">=</span><span class="s2">"-A"</span>
        <span class="nv">ipr</span><span class="o">=</span><span class="s2">"add"</span>
        <span class="p">;;</span>
    down<span class="p">)</span>
        <span class="nv">ipt</span><span class="o">=</span><span class="s2">"-D"</span>
        <span class="nv">ipr</span><span class="o">=</span><span class="s2">"del"</span>
        <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
        <span class="nb">help</span>
        <span class="p">;;</span>
<span class="k">esac</span>

<span class="c"># get wireless gateway ip</span>
<span class="nv">wlo1gw</span><span class="o">=</span><span class="si">$(</span> ip r | <span class="nb">grep</span> <span class="nt">-Po</span> <span class="s2">"default via </span><span class="se">\K</span><span class="s2">(</span><span class="se">\d</span><span class="s2">+</span><span class="se">\.</span><span class="s2">?){4} .* wlo1"</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f1</span> <span class="si">)</span>
<span class="c"># get my ip on this wireless nw</span>
<span class="nv">wlo1ip</span><span class="o">=</span><span class="si">$(</span> ip <span class="nt">-f</span> inet a show wlo1 | <span class="nb">awk</span> <span class="s1">'/inet/{ print $2 }'</span> | <span class="nb">cut</span> <span class="nt">-d</span>/ <span class="nt">-f1</span> <span class="si">)</span>

<span class="c"># any of them empty? ditch</span>
<span class="o">[[</span> <span class="nt">-z</span> <span class="nv">$wlo1gw</span> <span class="o">||</span> <span class="nt">-z</span> <span class="nv">$wlo1ip</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="o">&gt;</span>&amp;2 <span class="nb">echo</span> <span class="s2">"wlo1 down?"</span><span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>

<span class="c"># create table which sends via wireless iface</span>
<span class="nb">sudo </span>ip route <span class="nv">$ipr</span> table 22 default via <span class="nv">$wlo1gw</span>
<span class="c"># add rule for marked packets to get routed by the table above</span>
<span class="nb">sudo </span>ip rule <span class="nv">$ipr</span> fwmark 0x1 table 22
<span class="c"># mark ssh packets which are going out via eth iface</span>
<span class="nb">sudo </span>iptables <span class="nt">-t</span> mangle <span class="nv">$ipt</span> OUTPUT <span class="nt">-o</span> eno1 <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> MARK <span class="nt">--set-mark</span> 1
<span class="c"># since im going to change the iface, set source ip to that iface's ip</span>
<span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nv">$ipt</span> POSTROUTING <span class="nt">-o</span> wlo1 <span class="nt">-p</span> tcp <span class="nt">--dport</span> 22 <span class="nt">-j</span> SNAT <span class="nt">--to</span> <span class="nv">$wlo1ip</span>
</code></pre></div></div>

<div class="text-center py-4">· · ·</div>

<h1 class="section-header"></h1>

<p>This script, along with various other scripts config files can be found in my <a href="https://github.com/yoogottamk/dotfiles" target="_blank" rel="noopener">dotfiles</a> repo.</p>


  <div class="suggested row">
    
    <div class="col-md-4 col-sm-12"
      style="background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 1)), url(/assets/images/posts/edit-vim.webp);">
      <a class="prev stretched-link" href="/blog/vim-anywhere"></a>
      <span class="post-title">&laquo; Editing in vim from anywhere*</span>
    </div>
    

    
  </div>
</div>

  </div>

  <link rel="stylesheet" href="/css/footer.css">

<footer class="footer fixed-bottom">
  <div class="container d-flex flex-row justify-content-between">
    <span class="d-flex align-items-center">Yoogottam Khandelwal</span>
    <span>
      <ul class="list-unstyled list-group list-group-horizontal">
        
          <li class="icon-li"><a href="https://github.com/yoogottamk/" target="_blank" rel="noopener"><i class="fa fa-github"></i></a></li>
        
          <li class="icon-li"><a href="https://www.linkedin.com/in/yoogottamk/" target="_blank" rel="noopener"><i class="fa fa-linkedin-square"></i></a></li>
        
          <li class="icon-li"><a href="https://www.facebook.com/yoogottamk" target="_blank" rel="noopener"><i class="fa fa-facebook"></i></a></li>
        
          <li class="icon-li"><a href="mailto:yoogottamk@outlook.com" target="_blank" rel="noopener"><i class="fa fa-envelope"></i></a></li>
        
      </ul>
    </span>
  </div>

  <div class="container credits w-100 text-right">
    
      <hr>
      Pictures from
    
    
      <ul class="list-unstyled">
        <li><a href="https://unsplash.com/photos/KTpSVEcU0XU" target="_blank" rel="noopener">Vladislav Babienko, unsplash</a></li>
      </ul>
    
  </div>
</footer>


  <!-- included at the end of body, as all script files should -->

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
  integrity="sha512-bnIvzh6FU75ZKxp0GXLH9bewza/OIw6dLVh9ICg0gogclmYGguQJWl8U30WpbsGTqbIiAwxTsbe76DErLq5EDQ=="
  crossorigin="anonymous"></script>

<script
  src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
  integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
  crossorigin="anonymous"></script>

<script
  src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
  integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
  crossorigin="anonymous"></script>

<script src="/js/copy-code.js"></script>

</body>
</html>
